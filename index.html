<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Octra Wallet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 500px;
            margin: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], input[type="password"], input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .wallet-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .wallet-info h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
            word-break: break-all;
        }

        .transaction-history {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
        }

        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-incoming {
            border-left: 4px solid #28a745;
        }

        .transaction-outgoing {
            border-left: 4px solid #dc3545;
        }

        .transaction-pending {
            border-left: 4px solid #ffc107;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .send-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Octra Wallet</h1>
            <p>ƒêƒÉng nh·∫≠p v√†o v√≠ Octra c·ªßa b·∫°n ƒë·ªÉ ti·∫øp t·ª•c</p>
        </div>

        <div class="content">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label for="privateKey">Private Key:</label>
                    <input type="password" id="privateKey" placeholder="Nh·∫≠p private key c·ªßa b·∫°n">
                </div>

                <div class="form-group">
                    <label for="address">Address:</label>
                    <input type="text" id="address" placeholder="Nh·∫≠p address c·ªßa b·∫°n">
                </div>

                <div class="form-group">
                    <label for="rpcUrl">RPC URL:</label>
                    <input type="text" id="rpcUrl" value="https://octra.network" placeholder="RPC URL">
                </div>

                <button class="btn btn-primary" onclick="login()">ƒêƒÉng nh·∫≠p</button>
            </div>

            <!-- Wallet Dashboard -->
            <div id="walletDashboard" class="hidden">
                <div class="wallet-info">
                    <h3>üíº Th√¥ng tin v√≠</h3>
                    <div class="info-item">
                        <span class="info-label">Address:</span>
                        <span class="info-value" id="walletAddress">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Balance:</span>
                        <span class="info-value" id="walletBalance">0.000000 OCTRA</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Nonce:</span>
                        <span class="info-value" id="walletNonce">0</span>
                    </div>
                </div>

                <!-- Send Transaction Form -->
                <div class="send-form">
                    <h3>üí∏ G·ª≠i giao d·ªãch</h3>
                    <div class="form-group">
                        <label for="sendTo">ƒê·ªãa ch·ªâ nh·∫≠n:</label>
                        <input type="text" id="sendTo" placeholder="oct...">
                    </div>
                    <div class="form-group">
                        <label for="sendAmount">S·ªë l∆∞·ª£ng:</label>
                        <input type="number" id="sendAmount" placeholder="0.000000" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label for="sendMessage">Tin nh·∫Øn (t√πy ch·ªçn):</label>
                        <input type="text" id="sendMessage" placeholder="Tin nh·∫Øn giao d·ªãch">
                    </div>
                    <button class="btn btn-primary" onclick="sendTransaction()">G·ª≠i giao d·ªãch</button>
                </div>

                <!-- Transaction History -->
                <div style="margin-top: 30px;">
                    <h3>üìã L·ªãch s·ª≠ giao d·ªãch</h3>
                    <div id="transactionHistory" class="transaction-history">
                        <div class="loading">ƒêang t·∫£i l·ªãch s·ª≠ giao d·ªãch...</div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="logout()" style="margin-top: 20px;">ƒêƒÉng xu·∫•t</button>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let walletAddress = null;

        // ============= ERROR HANDLING - S·ª¨A L·ªñI CH√çNH =============

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                let data;
                const contentType = response.headers.get('content-type');
                
                // Ki·ªÉm tra xem response c√≥ ph·∫£i JSON kh√¥ng
                if (contentType && contentType.includes('application/json')) {
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        console.error('JSON parse error:', jsonError);
                        throw new Error(`Invalid JSON response from server`);
                    }
                } else {
                    // Server tr·∫£ v·ªÅ HTML error page
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error(`Server returned non-JSON response: ${response.status} ${response.statusText}`);
                }

                // Ki·ªÉm tra response status
                if (!response.ok) {
                    const errorMessage = data.error || data.message || `HTTP ${response.status}`;
                    throw new Error(errorMessage);
                }

                return data;
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'error');
        }

        // ============= AUTHENTICATION =============

        async function login() {
            try {
                const privateKey = document.getElementById('privateKey').value.trim();
                const address = document.getElementById('address').value.trim();
                const rpcUrl = document.getElementById('rpcUrl').value.trim() || 'https://octra.network';

                if (!privateKey || !address) {
                    showError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß private key v√† address');
                    return;
                }

                // Validate address format
                if (!address.match(/^oct[1-9A-HJ-NP-Za-km-z]{44}$/)) {
                    showError('ƒê·ªãnh d·∫°ng address kh√¥ng h·ª£p l·ªá');
                    return;
                }

                const data = await makeRequest('/api/wallet/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        private_key: privateKey,
                        address: address,
                        rpc_url: rpcUrl
                    })
                });

                if (data.success) {
                    sessionId = data.session_id;
                    walletAddress = data.address;
                    
                    // Store in sessionStorage
                    sessionStorage.setItem('session_id', sessionId);
                    sessionStorage.setItem('wallet_address', walletAddress);
                    
                    showSuccess('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                    showWalletDashboard();
                    loadWalletData();
                } else {
                    showError(data.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
                }
            } catch (error) {
                showError(`L·ªói ƒëƒÉng nh·∫≠p: ${error.message}`);
            }
        }

        async function logout() {
            try {
                if (sessionId) {
                    await makeRequest('/api/wallet/logout', {
                        method: 'POST',
                        body: JSON.stringify({
                            session_id: sessionId
                        })
                    });
                }
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                sessionId = null;
                walletAddress = null;
                sessionStorage.removeItem('session_id');
                sessionStorage.removeItem('wallet_address');
                showLoginForm();
                showSuccess('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng');
            }
        }

        // ============= UI MANAGEMENT =============

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('walletDashboard').classList.add('hidden');
        }

        function showWalletDashboard() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('walletDashboard').classList.remove('hidden');
        }

        // ============= WALLET DATA =============

        async function loadWalletData() {
            if (!sessionId) return;

            try {
                // Load wallet status
                const statusData = await makeRequest('/api/wallet/status', {
                    method: 'POST',
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                if (statusData.success) {
                    document.getElementById('walletAddress').textContent = statusData.address;
                    document.getElementById('walletBalance').textContent = `${statusData.balance.toFixed(6)} OCTRA`;
                    document.getElementById('walletNonce').textContent = statusData.nonce;
                }

                // Load transaction history
                await loadTransactionHistory();

            } catch (error) {
                console.error('Error loading wallet data:', error);
                showError(`L·ªói t·∫£i d·ªØ li·ªáu v√≠: ${error.message}`);
            }
        }

        async function loadTransactionHistory() {
            if (!sessionId) return;

            try {
                const historyData = await makeRequest('/api/wallet/history', {
                    method: 'POST',
                    body: JSON.stringify({
                        session_id: sessionId,
                        limit: 20
                    })
                });

                if (historyData.success) {
                    displayTransactionHistory(historyData.transactions);
                }
            } catch (error) {
                console.error('Error loading transaction history:', error);
                document.getElementById('transactionHistory').innerHTML = 
                    '<div class="loading">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ giao d·ªãch</div>';
            }
        }

        function displayTransactionHistory(transactions) {
            const historyContainer = document.getElementById('transactionHistory');
            
            if (!transactions || transactions.length === 0) {
                historyContainer.innerHTML = '<div class="loading">Ch∆∞a c√≥ giao d·ªãch n√†o</div>';
                return;
            }

            const historyHTML = transactions.map(tx => {
                const typeClass = tx.type === 'incoming' ? 'transaction-incoming' : 
                                 tx.type === 'outgoing' ? 'transaction-outgoing' : 'transaction-pending';
                const typeIcon = tx.type === 'incoming' ? 'üì•' : 
                                tx.type === 'outgoing' ? 'üì§' : '‚è≥';
                const amountPrefix = tx.type === 'incoming' ? '+' : '-';
                
                return `
                    <div class="transaction-item ${typeClass}">
                        <div>
                            <div style="font-weight: 600;">
                                ${typeIcon} ${amountPrefix}${tx.amount.toFixed(6)} OCTRA
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${tx.type === 'incoming' ? 'T·ª´' : 'ƒê·∫øn'}: ${tx.address.substring(0, 10)}...
                            </div>
                            ${tx.message ? `<div style="font-size: 0.8em; color: #888;">${tx.message}</div>` : ''}
                        </div>
                        <div style="text-align: right; font-size: 0.8em; color: #666;">
                            <div>${new Date(tx.time).toLocaleDateString('vi-VN')}</div>
                            <div>${new Date(tx.time).toLocaleTimeString('vi-VN')}</div>
                            <div style="color: ${tx.confirmed ? '#28a745' : '#ffc107'};">
                                ${tx.confirmed ? 'ƒê√£ x√°c nh·∫≠n' : 'ƒêang ch·ªù'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            historyContainer.innerHTML = historyHTML;
        }

        // ============= SEND TRANSACTION =============

        async function sendTransaction() {
            if (!sessionId) {
                showError('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
                return;
            }

            try {
                const toAddress = document.getElementById('sendTo').value.trim();
                const amount = parseFloat(document.getElementById('sendAmount').value);
                const message = document.getElementById('sendMessage').value.trim();

                // Validate inputs
                if (!toAddress) {
                    showError('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n');
                    return;
                }

                if (!toAddress.match(/^oct[1-9A-HJ-NP-Za-km-z]{44}$/)) {
                    showError('ƒê·ªãnh d·∫°ng ƒë·ªãa ch·ªâ nh·∫≠n kh√¥ng h·ª£p l·ªá');
                    return;
                }

                if (!amount || amount <= 0) {
                    showError('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá');
                    return;
                }

                if (amount > 1000000) {
                    showError('S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 1,000,000 OCTRA');
                    return;
                }

                const sendData = {
                    session_id: sessionId,
                    to: toAddress,
                    amount: amount
                };

                if (message) {
                    sendData.message = message;
                }

                const result = await makeRequest('/api/wallet/send', {
                    method: 'POST',
                    body: JSON.stringify(sendData)
                });

                if (result.success) {
                    showSuccess(`Giao d·ªãch ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! TX Hash: ${result.tx_hash}`);
                    
                    // Clear form
                    document.getElementById('sendTo').value = '';
                    document.getElementById('sendAmount').value = '';
                    document.getElementById('sendMessage').value = '';
                    
                    // Reload wallet data
                    setTimeout(() => {
                        loadWalletData();
                    }, 2000);
                } else {
                    showError(result.error || 'G·ª≠i giao d·ªãch th·∫•t b·∫°i');
                }
            } catch (error) {
                showError(`L·ªói g·ª≠i giao d·ªãch: ${error.message}`);
            }
        }

        // ============= INITIALIZATION =============

        // Check for existing session on page load
        window.addEventListener('load', () => {
            const storedSessionId = sessionStorage.getItem('session_id');
            const storedAddress = sessionStorage.getItem('wallet_address');
            
            if (storedSessionId && storedAddress) {
                sessionId = storedSessionId;
                walletAddress = storedAddress;
                showWalletDashboard();
                loadWalletData();
            } else {
                showLoginForm();
            }
        });

        // Auto refresh wallet data every 30 seconds
        setInterval(() => {
            if (sessionId && !document.getElementById('walletDashboard').classList.contains('hidden')) {
                loadWalletData();
            }
        }, 30000);

        // Handle Enter key in forms
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('loginForm').classList.contains('hidden')) {
                    login();
                } else if (!document.getElementById('walletDashboard').classList.contains('hidden')) {
                    sendTransaction();
                }
            }
        });
    </script>
</body>
</html>
