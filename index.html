<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ví Octra</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .login-form, .wallet-info {
            display: none;
        }
        .login-form.active, .wallet-info.active {
            display: block;
        }
        input, button, select {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .auto-send-btn {
            background-color: #28a745;
        }
        .auto-send-btn:hover {
            background-color: #1e7e34;
        }
        .auto-send-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .success {
            color: green;
            margin: 10px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .transaction {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .transaction.in {
            border-left: 4px solid #28a745;
        }
        .transaction.out {
            border-left: 4px solid #dc3545;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }
        .auto-send-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
        }
        .auto-send-log {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Ví Octra Web</h1>
    
    <!-- Form đăng nhập -->
    <div class="container login-form active" id="loginForm">
        <h2>Đăng nhập Ví Octra</h2>
        <input type="text" id="privateKey" placeholder="Private Key:" />
        <input type="text" id="address" placeholder="Địa chỉ ví:" />
        <input type="text" id="rpcUrl" placeholder="RPC URL:" value="https://octra.network" />
        <button onclick="login()">Đăng nhập</button>
        <div id="loginError" class="error"></div>
    </div>

    <!-- Thông tin ví -->
    <div class="container wallet-info" id="walletInfo">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Ví Octra Web</h2>
            <div>
                <span style="background-color: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                    Môi trường Testnet
                </span>
                <button onclick="logout()" style="width: auto; margin-left: 10px;">Đăng xuất</button>
            </div>
        </div>

        <div class="info-row">
            <strong>Địa chỉ</strong>
            <span id="walletAddress">Đang tải...</span>
        </div>
        <div class="info-row">
            <strong>Số dư</strong>
            <span id="walletBalance">Đang tải...</span>
        </div>
        <div class="info-row">
            <strong>Nonce</strong>
            <span id="walletNonce">Đang tải...</span>
        </div>
        <div class="info-row">
            <strong>Giao dịch chờ</strong>
            <span id="stagingCount">Đang tải...</span>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="showSendModal()">Gửi giao dịch</button>
            <button onclick="refreshBalance()">Làm mới số dư</button>
            <button onclick="showExportModal()">Xuất khóa</button>
            <button onclick="clearHistory()">Xóa lịch sử</button>
        </div>

        <!-- Chức năng gửi tự động -->
        <div class="container">
            <h3>Gửi Giao Dịch Tự Động</h3>
            <div class="auto-send-status" id="autoSendStatus">
                <strong>Trạng thái:</strong> <span id="autoSendStatusText">Đã dừng</span>
            </div>
            <div style="margin: 10px 0;">
                <label>Khoảng thời gian (giây):</label>
                <input type="number" id="autoSendInterval" value="5" min="1" max="60" style="width: 100px;">
            </div>
            <button id="autoSendBtn" class="auto-send-btn" onclick="toggleAutoSend()">
                Bắt đầu gửi tự động
            </button>
            <div class="auto-send-log" id="autoSendLog"></div>
        </div>

        <h3>Giao dịch gần đây</h3>
        <div id="transactionHistory">Đang tải giao dịch...</div>
    </div>

    <!-- Modal gửi giao dịch -->
    <div id="sendModal" class="modal">
        <div class="modal-content">
            <h3>Gửi giao dịch</h3>
            <input type="text" id="sendAddress" placeholder="Địa chỉ nhận:" />
            <input type="number" id="sendAmount" placeholder="Số lượng (OCT):" step="0.000001" />
            <input type="text" id="sendMessage" placeholder="Tin nhắn (Tùy chọn):" />
            <button onclick="sendTransaction()">Gửi giao dịch</button>
            <button onclick="closeSendModal()">Hủy</button>
            <div id="sendError" class="error"></div>
        </div>
    </div>

    <!-- Modal xuất khóa -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h3>Xuất khóa ví</h3>
            <p><strong>Private Key (Giữ bí mật!):</strong></p>
            <textarea id="exportPrivateKey" readonly style="width: 100%; height: 60px;"></textarea>
            <p><strong>Public Key:</strong></p>
            <textarea id="exportPublicKey" readonly style="width: 100%; height: 60px;"></textarea>
            <button onclick="copyPrivateKey()">Sao chép Private Key</button>
            <button onclick="copyPublicKey()">Sao chép Public Key</button>
            <button onclick="closeExportModal()">Đóng</button>
        </div>
    </div>

    <script>
        let sessionId = null;
        let autoSendInterval = null;
        let autoSendRunning = false;

        // Hàm tạo ví ngẫu nhiên
        function generateRandomWallet() {
            const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            let result = 'oct';
            for (let i = 0; i < 44; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Hàm tạo tin nhắn ngẫu nhiên
        function generateRandomMessage() {
            const messages = [
                'Giao dịch tự động',
                'Test transaction',
                'Auto send OCT',
                'Random transfer',
                'Automated payment',
                'System test',
                'Auto transaction',
                'Test payment',
                'Random send',
                'Automated transfer'
            ];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        // Hàm log cho auto send
        function logAutoSend(message) {
            const logElement = document.getElementById('autoSendLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Hàm toggle auto send
        async function toggleAutoSend() {
            const btn = document.getElementById('autoSendBtn');
            const statusText = document.getElementById('autoSendStatusText');
            const intervalInput = document.getElementById('autoSendInterval');

            if (autoSendRunning) {
                // Dừng auto send
                clearInterval(autoSendInterval);
                autoSendRunning = false;
                btn.textContent = 'Bắt đầu gửi tự động';
                btn.className = 'auto-send-btn';
                statusText.textContent = 'Đã dừng';
                intervalInput.disabled = false;
                logAutoSend('Đã dừng gửi tự động');
            } else {
                // Bắt đầu auto send
                const interval = parseInt(intervalInput.value) * 1000;
                if (interval < 1000) {
                    alert('Khoảng thời gian tối thiểu là 1 giây');
                    return;
                }

                autoSendRunning = true;
                btn.textContent = 'Dừng gửi tự động';
                btn.className = 'auto-send-btn';
                statusText.textContent = 'Đang chạy';
                intervalInput.disabled = true;
                logAutoSend('Bắt đầu gửi tự động');

                autoSendInterval = setInterval(async () => {
                    await performAutoSend();
                }, interval);
            }
        }

        // Hàm thực hiện gửi tự động
        async function performAutoSend() {
            try {
                const randomAddress = generateRandomWallet();
                const amount = 0.00001;
                const message = generateRandomMessage();

                logAutoSend(`Đang gửi ${amount} OCT đến ${randomAddress.substring(0, 10)}...`);

                const response = await fetch('/api/wallet/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        to: randomAddress,
                        amount: amount,
                        message: message
                    })
                });

                const result = await response.json();

                if (result.success) {
                    logAutoSend(`✓ Thành công! TX: ${result.tx_hash.substring(0, 10)}...`);
                    await refreshBalance();
                    await loadHistory();
                } else {
                    logAutoSend(`✗ Lỗi: ${result.error}`);
                    if (result.error.includes('Số dư không đủ')) {
                        // Dừng auto send nếu hết tiền
                        toggleAutoSend();
                        logAutoSend('Đã dừng do không đủ số dư');
                    }
                }
            } catch (error) {
                logAutoSend(`✗ Lỗi kết nối: ${error.message}`);
            }
        }

        // Các hàm khác giữ nguyên...
        async function login() {
            const privateKey = document.getElementById('privateKey').value.trim();
            const address = document.getElementById('address').value.trim();
            const rpcUrl = document.getElementById('rpcUrl').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!privateKey || !address) {
                errorDiv.textContent = 'Vui lòng nhập đầy đủ Private Key và Address';
                return;
            }

            try {
                const response = await fetch('/api/wallet/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        private_key: privateKey,
                        address: address,
                        rpc_url: rpcUrl
                    })
                });

                const result = await response.json();

                if (result.success) {
                    sessionId = result.session_id;
                    document.getElementById('loginForm').classList.remove('active');
                    document.getElementById('walletInfo').classList.add('active');
                    await loadWalletInfo();
                } else {
                    errorDiv.textContent = result.error;
                }
            } catch (error) {
                errorDiv.textContent = 'Lỗi kết nối: ' + error.message;
            }
        }

        async function logout() {
            if (autoSendRunning) {
                toggleAutoSend();
            }

            try {
                await fetch('/api/wallet/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            sessionId = null;
            document.getElementById('walletInfo').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('privateKey').value = '';
            document.getElementById('address').value = '';
            document.getElementById('loginError').textContent = '';
        }

        async function loadWalletInfo() {
            try {
                const response = await fetch('/api/wallet/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                const result = await response.json();

                if (result.error) {
                    alert(result.error);
                    await logout();
                    return;
                }

                document.getElementById('walletAddress').textContent = result.address;
                document.getElementById('walletBalance').textContent = `${result.balance.toFixed(6)} OCT`;
                document.getElementById('walletNonce').textContent = result.nonce;
                document.getElementById('stagingCount').textContent = result.staging_count;

                await loadHistory();
            } catch (error) {
                console.error('Load wallet info error:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/wallet/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                const result = await response.json();
                const historyDiv = document.getElementById('transactionHistory');

                if (result.transactions && result.transactions.length > 0) {
                    historyDiv.innerHTML = result.transactions.map(tx => `
                        <div class="transaction ${tx.type}">
                            <div><strong>${tx.type === 'in' ? 'Nhận' : 'Gửi'}</strong> ${tx.amount.toFixed(6)} OCT</div>
                            <div><strong>Địa chỉ:</strong> ${tx.address}</div>
                            <div><strong>Thời gian:</strong> ${new Date(tx.time).toLocaleString()}</div>
                            <div><strong>Hash:</strong> ${tx.hash}</div>
                            ${tx.message ? `<div><strong>Tin nhắn:</strong> ${tx.message}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = '<p>Chưa có giao dịch nào</p>';
                }
            } catch (error) {
                console.error('Load history error:', error);
            }
        }

        async function refreshBalance() {
            await loadWalletInfo();
        }

        function showSendModal() {
            document.getElementById('sendModal').style.display = 'block';
        }

        function closeSendModal() {
            document.getElementById('sendModal').style.display = 'none';
            document.getElementById('sendError').textContent = '';
        }

        async function sendTransaction() {
            const address = document.getElementById('sendAddress').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const message = document.getElementById('sendMessage').value.trim();
            const errorDiv = document.getElementById('sendError');

            if (!address || !amount || amount <= 0) {
                errorDiv.textContent = 'Vui lòng nhập đầy đủ thông tin hợp lệ';
                return;
            }

            try {
                const response = await fetch('/api/wallet/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        to: address,
                        amount: amount,
                        message: message || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Giao dịch thành công!\nHash: ${result.tx_hash}`);
                    closeSendModal();
                    await refreshBalance();
                    await loadHistory();
                } else {
                    errorDiv.textContent = result.error;
                }
            } catch (error) {
                errorDiv.textContent = 'Lỗi kết nối: ' + error.message;
            }
        }

        function showExportModal() {
            fetch('/api/wallet/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: sessionId
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                    return;
                }
                document.getElementById('exportPrivateKey').value = result.private_key;
                document.getElementById('exportPublicKey').value = result.public_key;
                document.getElementById('exportModal').style.display = 'block';
            })
            .catch(error => {
                alert('Lỗi: ' + error.message);
            });
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function copyPrivateKey() {
            const textarea = document.getElementById('exportPrivateKey');
            textarea.select();
            document.execCommand('copy');
            alert('Đã sao chép Private Key!');
        }

        function copyPublicKey() {
            const textarea = document.getElementById('exportPublicKey');
            textarea.select();
            document.execCommand('copy');
            alert('Đã sao chép Public Key!');
        }

        function clearHistory() {
            if (confirm('Bạn có chắc muốn xóa lịch sử giao dịch?')) {
                document.getElementById('transactionHistory').innerHTML = '<p>Chưa có giao dịch nào</p>';
                alert('Đã xóa lịch sử!');
            }
        }

        // Đóng modal khi click bên ngoài
        window.onclick = function(event) {
            const sendModal = document.getElementById('sendModal');
            const exportModal = document.getElementById('exportModal');
            if (event.target === sendModal) {
                closeSendModal();
            }
            if (event.target === exportModal) {
                closeExportModal();
            }
        }
    </script>
</body>
</html>
